<!--records.wxml-->
<view class="page">
  <!-- éœ€è¦ç™»å½•æç¤º -->
  <view wx:if="{{needLogin}}" class="login-container">
    <view class="login-card">
      <text class="login-icon">ğŸ”</text>
      <text class="login-title">ç™»å½•åæŸ¥çœ‹è®°å½•</text>
      <text class="login-desc">ç®¡ç†æ‚¨çš„å……å€¼å’Œè´­ä¹°è®°å½•</text>
      <navigator url="/pages/user/user" open-type="switchTab" class="login-button">
        å‰å¾€ç™»å½•
      </navigator>
    </view>
  </view>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <view wx:else class="main-container">
    <!-- é¡¶éƒ¨æ ‡ç­¾æ  -->
    <view class="tab-bar">
      <view class="tab-item {{activeTab === 'all' ? 'active' : ''}}" 
            bindtap="switchTab" data-tab="all">
        <text class="tab-text">å…¨éƒ¨</text>
        <view wx:if="{{activeTab === 'all'}}" class="tab-indicator"></view>
      </view>
      <view class="tab-item {{activeTab === 'recharge' ? 'active' : ''}}" 
            bindtap="switchTab" data-tab="recharge">
        <text class="tab-text">å……å€¼</text>
        <view wx:if="{{activeTab === 'recharge'}}" class="tab-indicator"></view>
      </view>
      <view class="tab-item {{activeTab === 'purchase' ? 'active' : ''}}" 
            bindtap="switchTab" data-tab="purchase">
        <text class="tab-text">è´­ä¹°</text>
        <view wx:if="{{activeTab === 'purchase'}}" class="tab-indicator"></view>
      </view>
      <view class="tab-item {{activeTab === 'sell' ? 'active' : ''}}" 
            bindtap="switchTab" data-tab="sell">
        <text class="tab-text">å–å‡º</text>
        <view wx:if="{{activeTab === 'sell'}}" class="tab-indicator"></view>
      </view>
    </view>

    <!-- å†…å®¹åŒºåŸŸ -->
    <scroll-view class="content-area" 
                 scroll-y 
                 bindscrolltolower="loadMore"
                 refresher-enabled="{{true}}"
                 refresher-triggered="{{refreshing}}"
                 bindrefresherrefresh="onRefresh">
      
      <!-- è®°å½•åˆ—è¡¨ -->
      <view class="records-container" wx:if="{{records.length > 0}}">
        <view wx:for="{{records}}" wx:for-index="recordIndex" wx:key="_id" class="record-wrapper">
          
          <!-- å……å€¼è®°å½• -->
          <view wx:if="{{item.type === 'recharge'}}" class="record-card">
            <view class="record-badge recharge-badge"></view>
            <view class="record-content">
              <view class="record-header">
                <view class="record-left">
                  <view class="record-title-area">
                    <text class="record-icon">ğŸ’°</text>
                    <view class="record-info">
                      <text class="record-title">è´¦æˆ·å……å€¼</text>
                      <text class="record-time">{{item.timeStr}}</text>
                    </view>
                  </view>
                  <view class="record-details-inline">
                    <text class="detail-item">æ±‡ç‡ 1:{{item.exchange_rate}}</text>
                    <text class="detail-separator">â€¢</text>
                    <view class="detail-item-with-toggle">
                      <text class="detail-item primary">å‰©ä½™ ${{item.remaining_usd}}</text>
                      <view class="detail-toggle" bindtap="toggleRechargeDetails" data-index="{{recordIndex}}">
                        <text class="toggle-icon">{{item.detailsExpanded ? 'â–²' : 'â–¼'}}</text>
                      </view>
                    </view>
                  </view>
                </view>
                <view class="record-right">
                  <view class="record-amount-area">
                    <text class="amount-usd positive">+${{item.usd_amount}}</text>
                    <text class="amount-rmb">Â¥{{item.rmb_amount}}</text>
                  </view>
                  <view class="record-actions-compact">
                    <view class="action-icon edit" bindtap="editRecord" data-item="{{item}}">
                      <text class="icon">âœï¸</text>
                    </view>
                    <view class="action-icon delete" bindtap="deleteRecord" 
                          data-id="{{item._id}}" data-type="recharge">
                      <text class="icon">ğŸ—‘ï¸</text>
                    </view>
                  </view>
                </view>
              </view>
              
              <view class="record-details {{item.detailsExpanded ? 'expanded' : 'collapsed'}}" wx:if="{{item.detailsExpanded}}">
                <text class="detail-section-title">å……å€¼è¯¦æƒ…</text>
                <view class="cost-details">
                  <view class="detail-row">
                    <text class="detail-label">äººæ°‘å¸é‡‘é¢</text>
                    <text class="detail-value">Â¥{{item.rmb_amount}}</text>
                  </view>
                  <view class="detail-row">
                    <text class="detail-label">ç¾å…ƒé‡‘é¢</text>
                    <text class="detail-value">${{item.usd_amount}}</text>
                  </view>
                  <view class="detail-row">
                    <text class="detail-label">æ±‡ç‡</text>
                    <text class="detail-value">1:{{item.exchange_rate}}</text>
                  </view>
                  <view class="detail-row">
                    <text class="detail-label">å‰©ä½™ç¾å…ƒ</text>
                    <text class="detail-value">${{item.remaining_usd}}</text>
                  </view>
                </view>
              </view>
            </view>
          </view>

          <!-- è´­ä¹°è®°å½• -->
          <view wx:elif="{{item.type === 'purchase'}}" class="record-card">
            <view class="record-badge purchase-badge"></view>
            <view class="record-content">
              <view class="record-header">
                <view class="record-left">
                  <view class="record-title-area">
                    <text class="record-icon">ğŸ›ï¸</text>
                    <view class="record-info">
                      <view class="record-title-row">
                        <text class="record-title">{{item.item_name}}</text>
                        <view wx:if="{{item.item_type}}" class="item-type-tag">
                          <text class="type-icon">{{item.item_type_icon}}</text>
                          <text class="type-text">{{item.item_type_label}}</text>
                        </view>
                      </view>
                      <text class="record-time">{{item.timeStr}}</text>
                    </view>
                  </view>
                  <view class="record-details-inline" wx:if="{{item.recharge_details && item.recharge_details.length > 0}}">
                    <text class="detail-item">æˆæœ¬æ˜ç»†</text>
                    <text class="detail-separator">â€¢</text>
                    <view class="detail-item-with-toggle">
                      <text class="detail-item primary">{{item.recharge_details.length}}ç¬”æ±‡ç‡</text>
                      <view class="detail-toggle" bindtap="togglePurchaseDetails" data-index="{{recordIndex}}">
                        <text class="toggle-icon">{{item.detailsExpanded ? 'â–²' : 'â–¼'}}</text>
                      </view>
                    </view>
                  </view>
                </view>
                <view class="record-right">
                  <view class="record-amount-area">
                    <text class="amount-usd negative">-${{item.usd_price}}</text>
                    <text class="amount-rmb">Â¥{{item.rmb_cost}}</text>
                  </view>
                  <view class="record-actions-compact">
                    <view class="action-icon edit" bindtap="editRecord" data-item="{{item}}">
                      <text class="icon">âœï¸</text>
                    </view>
                    <view class="action-icon delete" bindtap="deleteRecord" 
                          data-id="{{item._id}}" data-type="purchase">
                      <text class="icon">ğŸ—‘ï¸</text>
                    </view>
                  </view>
                </view>
              </view>
              
              <view class="record-details {{item.detailsExpanded ? 'expanded' : 'collapsed'}}" wx:if="{{item.recharge_details && item.recharge_details.length > 0 && item.detailsExpanded}}">
                <text class="detail-section-title">æˆæœ¬æ˜ç»†</text>
                <view class="cost-details">
                  <view wx:for="{{item.recharge_details}}" wx:for-item="detail" wx:key="index" 
                        class="cost-item">
                    <text class="cost-text">${{detail.used_usd}} Ã— {{detail.exchange_rate}} = Â¥{{detail.rmb_cost}}</text>
                  </view>
                </view>
              </view>
            </view>
          </view>

          <!-- å–å‡ºè®°å½• -->
          <view wx:elif="{{item.type === 'sell'}}" class="record-card">
            <view class="record-badge sell-badge"></view>
            <view class="record-content">
              <view class="record-header">
                <view class="record-left">
                  <view class="record-title-area">
                    <text class="record-icon">ğŸ’¸</text>
                    <view class="record-info">
                      <view class="record-title-row">
                        <text class="record-title">{{item.item_name}}</text>
                        <view wx:if="{{item.item_type}}" class="item-type-tag">
                          <text class="type-icon">{{item.item_type_icon}}</text>
                          <text class="type-text">{{item.item_type_label}}</text>
                        </view>
                      </view>
                      <text class="record-time">{{item.timeStr}}</text>
                    </view>
                  </view>
                  <view class="record-details-inline">
                    <text class="detail-item profit-label">åˆ©æ¶¦</text>
                    <text class="detail-separator"></text>
                    <view class="detail-item-with-toggle">
                      <text class="detail-item primary {{item.profit >= 0 ? 'positive' : 'negative'}}">
                        {{item.profit >= 0 ? '+' : ''}}Â¥{{item.profit}}
                      </text>
                      <view class="detail-toggle" bindtap="toggleSellDetails" data-index="{{recordIndex}}">
                        <text class="toggle-icon">{{item.detailsExpanded ? 'â–²' : 'â–¼'}}</text>
                      </view>
                    </view>
                  </view>
                </view>
                <view class="record-right">
                  <view class="record-amount-area">
                    <text class="amount-usd positive">+Â¥{{item.total_sell_price_cny || item.unit_sell_price_cny}}</text>
                    <text class="amount-rmb">å–å‡ºæ”¶å…¥</text>
                  </view>
                  <view class="record-actions-compact">
                    <view class="action-icon edit" bindtap="editRecord" data-item="{{item}}">
                      <text class="icon">âœï¸</text>
                    </view>
                    <view class="action-icon delete" bindtap="deleteRecord" 
                          data-id="{{item._id}}" data-type="sell">
                      <text class="icon">ğŸ—‘ï¸</text>
                    </view>
                  </view>
                </view>
              </view>
              
              <view class="record-details {{item.detailsExpanded ? 'expanded' : 'collapsed'}}" wx:if="{{item.detailsExpanded}}">
                <text class="detail-section-title">äº¤æ˜“è¯¦æƒ…</text>
                <view class="cost-details">
                  <view class="detail-row">
                    <text class="detail-label">è´­ä¹°æˆæœ¬</text>
                    <text class="detail-value">${{item.total_purchase_price}} (Â¥{{item.total_purchase_price_cny}})</text>
                  </view>
                  <view class="detail-row">
                    <text class="detail-label">å–å‡ºä»·æ ¼</text>
                    <text class="detail-value">Â¥{{item.total_sell_price_cny}}</text>
                  </view>
                  <view class="detail-row" wx:if="{{item.platform}}">
                    <text class="detail-label">äº¤æ˜“å¹³å°</text>
                    <text class="detail-value">{{item.platform}}</text>
                  </view>
                  <view class="detail-row" wx:if="{{item.condition}}">
                    <text class="detail-label">ç‰©å“å“è´¨</text>
                    <text class="detail-value">{{item.condition}}</text>
                  </view>
                  <view class="detail-row" wx:if="{{item.notes}}">
                    <text class="detail-label">å¤‡æ³¨</text>
                    <text class="detail-value">{{item.notes}}</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- åŠ è½½æ›´å¤šæç¤º -->
        <view class="list-footer">
          <view wx:if="{{loading}}" class="loading-more">
            <text>åŠ è½½ä¸­...</text>
          </view>
          <view wx:elif="{{!hasMore}}" class="no-more">
            <text>å·²ç»åˆ°åº•äº†</text>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{!loading && records.length === 0}}" class="empty-container">
        <text class="empty-icon">ğŸ“‹</text>
        <text class="empty-title">æš‚æ— è®°å½•</text>
        <text class="empty-desc">{{activeTab === 'recharge' ? 'è¿˜æ²¡æœ‰å……å€¼è®°å½•' : activeTab === 'purchase' ? 'è¿˜æ²¡æœ‰è´­ä¹°è®°å½•' : activeTab === 'sell' ? 'è¿˜æ²¡æœ‰å–å‡ºè®°å½•' : 'è¿˜æ²¡æœ‰ä»»ä½•è®°å½•'}}</text>
      </view>

      <!-- åˆå§‹åŠ è½½ -->
      <view wx:if="{{loading && records.length === 0}}" class="initial-loading">
        <text class="loading-spinner">â³</text>
        <text class="loading-text">æ­£åœ¨åŠ è½½...</text>
      </view>
    </scroll-view>
  </view>
</view>

<!-- ç¼–è¾‘å¼¹çª— -->
<view wx:if="{{showEditModal}}" class="modal-overlay" bindtap="closeEditModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ç¼–è¾‘è®°å½•</text>
      <view class="modal-close" bindtap="closeEditModal">
        <text>âœ•</text>
      </view>
    </view>
    
    <view class="modal-body">
      <view class="input-group" wx:if="{{editingItem.type === 'purchase'}}">
        <text class="input-label">ç‰©å“åç§°</text>
        <input class="input-field" 
               value="{{editingItem.item_name}}" 
               bindinput="onEditItemName"
               placeholder="è¯·è¾“å…¥ç‰©å“åç§°" />
      </view>
      
      <view class="input-group">
        <text class="input-label">å¤‡æ³¨ä¿¡æ¯</text>
        <input class="input-field" 
               value="{{editingItem.remark || ''}}" 
               bindinput="onEditRemark"
               placeholder="è¯·è¾“å…¥å¤‡æ³¨" />
      </view>
    </view>
    
    <view class="modal-actions">
      <button class="modal-button cancel" bindtap="closeEditModal">å–æ¶ˆ</button>
      <button class="modal-button confirm" bindtap="confirmEdit">ç¡®å®š</button>
    </view>
  </view>
</view>