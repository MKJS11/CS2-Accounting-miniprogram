<!--index.wxml-->
<view class="container">
  <!-- éœ€è¦ç™»å½•æç¤º -->
  <view wx:if="{{needLogin}}" class="login-tip">
    <view class="tip-box">
      <text class="tip-icon">ğŸ”’</text>
      <text class="tip-title">è¯·å…ˆç™»å½•</text>
      <text class="tip-desc">ç™»å½•åæ‰èƒ½ä½¿ç”¨è®°è´¦åŠŸèƒ½</text>
      <button class="login-btn" bindtap="goToRecords">
        å»ç™»å½•
      </button>
    </view>
  </view>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <view wx:else>
    <!-- ä½™é¢å¡ç‰‡ -->
  <view class="balance-card">
    <view class="balance-title">steam</view>
    
    <!-- åŠ è½½ä¸­çš„éª¨æ¶å± -->
    <view wx:if="{{isLoading || !dataLoaded}}" class="balance-skeleton">
      <view class="balance-main skeleton">
        <view class="skeleton-text large"></view>
      </view>
      <view class="balance-sub skeleton">
        <view class="skeleton-text medium"></view>
      </view>
      <view class="balance-rate skeleton">
        <view class="skeleton-text small"></view>
      </view>
    </view>
    
    <!-- å®é™…æ•°æ® -->
    <view wx:else class="balance-content">
      <view class="balance-main">
        <text class="currency-symbol">$</text>
        <text class="balance-amount">{{balance.total_usd_balance}}</text>
      </view>
      <view class="balance-sub">
        <text>äººæ°‘å¸æˆæœ¬ï¼šÂ¥{{balance.total_rmb_cost}}</text>
      </view>
      <view class="balance-rate">
        <text>å¹³å‡æ±‡ç‡ï¼š{{balance.avg_exchange_rate}}</text>
      </view>
    </view>
  </view>

  <!-- å¿«é€Ÿæ“ä½œ -->
  <view class="quick-actions">
    <button class="action-btn recharge-btn" bindtap="goToRecharge">
      <text class="btn-icon">+</text>
      <text>è®°å½•</text>
    </button>
    <button class="action-btn purchase-btn" bindtap="goToPurchase">
      <text class="btn-icon">-</text>
      <text>å‡ºè´§</text>
    </button>
  </view>

  <!-- æœ€è¿‘äº¤æ˜“ -->
  <view class="recent-section">
    <view class="section-header">
      <text class="section-title">æœ€è¿‘äº¤æ˜“</text>
      <text class="view-all" bindtap="goToRecords">æŸ¥çœ‹å…¨éƒ¨ ></text>
    </view>
    
    <view class="transaction-list">
      <!-- åŠ è½½ä¸­çš„äº¤æ˜“è®°å½•éª¨æ¶å± -->
      <view wx:if="{{isLoading || !dataLoaded}}" class="transaction-skeleton">
        <view class="transaction-item-skeleton" wx:for="{{[1,2,3]}}" wx:key="index">
          <view class="trans-left">
            <view class="skeleton-text small"></view>
            <view class="skeleton-text medium"></view>
          </view>
          <view class="trans-right">
            <view class="skeleton-text small"></view>
            <view class="skeleton-text tiny"></view>
          </view>
        </view>
      </view>
      
      <!-- å®é™…äº¤æ˜“æ•°æ® -->
      <view wx:else>
        <block wx:for="{{recentTransactions}}" wx:key="index">
          <view class="transaction-item {{item.expanded ? 'expanded' : ''}}" bindtap="toggleTransactionDetail" data-index="{{index}}">
            <!-- åŸºç¡€ä¿¡æ¯è¡Œ -->
            <view class="trans-basic">
              <view class="trans-left">
                <view class="trans-type {{item.type}}">
                  {{item.type === 'recharge' ? 'å……å€¼' : (item.type === 'sell' ? 'å–å‡º' : 'è´­ä¹°')}}
                </view>
                <view class="trans-brief">
                  <text wx:if="{{item.type === 'recharge'}}" class="brief-text">
                    Steam é’±åŒ…å……å€¼
                  </text>
                  <text wx:else class="brief-text">
                    {{item.item_name}}
                  </text>
                </view>
              </view>
              <view class="trans-right">
                <view class="trans-amount {{item.type}}">
                  <text wx:if="{{item.type === 'recharge'}}">+${{item.usd_amount}}</text>
                  <text wx:elif="{{item.type === 'sell'}}">+Â¥{{item.total_sell_price_cny || item.unit_sell_price_cny}}</text>
                  <text wx:else>-${{item.display_total_price || item.usd_price}}</text>
                </view>
                <view class="expand-icon {{item.expanded ? 'rotated' : ''}}">â–¼</view>
              </view>
            </view>
            
            <!-- è¯¦ç»†ä¿¡æ¯ï¼ˆå¯æŠ˜å ï¼‰ -->
            <view class="trans-detail {{item.expanded ? 'show' : ''}}">
              <view class="detail-content">
                <!-- å……å€¼è¯¦æƒ… -->
                <view wx:if="{{item.type === 'recharge'}}" class="detail-row">
                  <text class="detail-label">äººæ°‘å¸é‡‘é¢ï¼š</text>
                  <text class="detail-value">Â¥{{item.rmb_amount}}</text>
                </view>
                <view wx:if="{{item.type === 'recharge'}}" class="detail-row">
                  <text class="detail-label">æ±‡ç‡ï¼š</text>
                  <text class="detail-value">{{item.exchange_rate}}</text>
                </view>
                
                <!-- è´­ä¹°/å–å‡ºè¯¦æƒ… -->
                <view wx:if="{{item.type !== 'recharge' && item.item_type}}" class="detail-row">
                  <text class="detail-label">ç‰©å“ç±»å‹ï¼š</text>
                  <view class="item-type-tag-detail">
                    <text class="type-icon-detail">{{item.item_type_icon}}</text>
                    <text class="type-text-detail">{{item.item_type_label}}</text>
                  </view>
                </view>
                <view wx:if="{{item.type === 'purchase'}}" class="detail-row">
                  <text class="detail-label">æ•°é‡ï¼š</text>
                  <text class="detail-value">{{item.quantity || 1}}</text>
                </view>
                <view wx:if="{{item.type === 'purchase'}}" class="detail-row">
                  <text class="detail-label">å•ä»·ï¼š</text>
                  <text class="detail-value">${{item.display_unit_price}} (Â¥{{item.unit_rmb_cost}})</text>
                </view>
                <view wx:if="{{item.type === 'purchase'}}" class="detail-row">
                  <text class="detail-label">æ€»ä»·ï¼š</text>
                  <text class="detail-value">${{item.display_total_price}} (Â¥{{item.rmb_cost}})</text>
                </view>
                <!-- å–å‡ºè®°å½•è¯¦æƒ… -->
                <view wx:if="{{item.type === 'sell'}}" class="detail-row">
                  <text class="detail-label">è´­ä¹°æˆæœ¬ï¼š</text>
                  <text class="detail-value">${{item.total_purchase_price}} (Â¥{{item.total_purchase_price_cny}})</text>
                </view>
                <view wx:if="{{item.type === 'sell'}}" class="detail-row">
                  <text class="detail-label">å–å‡ºä»·æ ¼ï¼š</text>
                  <text class="detail-value">Â¥{{item.total_sell_price_cny}}</text>
                </view>
                <view wx:if="{{item.type === 'sell' && item.remark}}" class="detail-row">
                  <text class="detail-label">å¤‡æ³¨ï¼š</text>
                  <text class="detail-value">{{item.remark}}</text>
                </view>
                
                <!-- æ—¶é—´ä¿¡æ¯ -->
                <view class="detail-row">
                  <text class="detail-label">äº¤æ˜“æ—¶é—´ï¼š</text>
                  <text class="detail-value time">{{item.timeStr}}</text>
                </view>
              </view>
            </view>
          </view>
        </block>
        
        <view wx:if="{{recentTransactions.length === 0}}" class="empty-state">
          <text>æš‚æ— äº¤æ˜“è®°å½•</text>
        </view>
      </view>
    </view>
  </view>
  </view>
</view>