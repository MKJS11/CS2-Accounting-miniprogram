<!--pages/inventory/inventory.wxml-->
<view class="inventory-container" bindtap="closeFilterDropdown">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½åº“å­˜ä¸­...</text>
  </view>

  <!-- åº“å­˜æ¦‚è§ˆ -->
  <view wx:else class="overview-section">
    <view class="summary-card">
      <view class="summary-header">
        <text class="summary-title">ğŸ“¦ åº“å­˜æ¦‚è§ˆ</text>
        <text class="summary-subtitle">å½“å‰æŒæœ‰ç‰©å“ç»Ÿè®¡</text>
      </view>
      
      <view class="summary-stats">
        <view class="stat-item">
          <text class="stat-label">ç‰©å“æ•°é‡</text>
          <text class="stat-value">{{totalInventory.totalItems}} ä»¶</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">ç¾å…ƒæˆæœ¬</text>
          <text class="stat-value">${{totalInventory.totalUsdCost}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">äººæ°‘å¸æˆæœ¬</text>
          <text class="stat-value">Â¥{{totalInventory.totalRmbCost}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åº“å­˜åˆ—è¡¨ -->
  <view wx:if="{{!loading}}" class="inventory-section">
    <!-- æœç´¢æ¡† -->
    <view class="search-container">
      <view class="search-box">
        <view class="search-icon">ğŸ”</view>
        <input 
          class="search-input" 
          type="text" 
          placeholder="æœç´¢ç‰©å“åç§°æˆ–ç±»å‹..." 
          value="{{searchKeyword}}" 
          bindinput="onSearchInput"
          bindconfirm="onSearchConfirm"
          confirm-type="search"
        />
        <view wx:if="{{searchKeyword}}" class="search-clear" bindtap="clearSearch">Ã—</view>
      </view>
    </view>
    
    <view class="section-header">
      <text class="section-title">ğŸ’ æˆ‘çš„åº“å­˜</text>
      <text class="section-count">{{filteredInventoryList.length}} ç§ç‰©å“</text>
      
      <view class="header-controls">
        <!-- åˆ†ç±»ç­›é€‰ -->
        <view class="filter-dropdown" catchtap="stopPropagation">
          <button class="filter-btn" bindtap="toggleFilterDropdown">
            <text class="filter-icon {{showFilterDropdown ? 'rotate' : ''}}">ğŸ”½</text>
            <text class="filter-text">åˆ†ç±»</text>
          </button>
          <!-- ä¸‹æ‹‰é€‰æ‹©æ¡† -->
          <view class="filter-dropdown-content {{showFilterDropdown ? 'show' : ''}}" catchtap="stopPropagation">
            <view 
              class="filter-dropdown-option {{selectedFilter === 'all' ? 'active' : ''}}"
              data-filter="all"
              bindtap="selectFilter"
            >
              <text class="filter-option-icon">ğŸ“¦</text>
              <text class="filter-option-text">å…¨éƒ¨</text>
              <text class="filter-option-count">({{allItemTypes.all}})</text>
            </view>
            
            <view 
              wx:for="{{availableTypes}}" 
              wx:key="type"
              class="filter-dropdown-option {{selectedFilter === item.type ? 'active' : ''}}"
              data-filter="{{item.type}}"
              bindtap="selectFilter"
            >
              <text class="filter-option-icon">{{item.icon}}</text>
              <text class="filter-option-text">{{item.label}}</text>
              <text class="filter-option-count">({{item.count}})</text>
            </view>
          </view>
        </view>

        <!-- æ’åºé€‰æ‹© -->
        <view class="sort-dropdown" catchtap="stopPropagation">
          <button class="sort-btn" bindtap="toggleSortDropdown">
            <text class="sort-icon {{showSortDropdown ? 'rotate' : ''}}">ğŸ”½</text>
            <text class="sort-text">æ’åº</text>
          </button>
          <!-- æ’åºä¸‹æ‹‰é€‰æ‹©æ¡† -->
          <view class="sort-dropdown-content {{showSortDropdown ? 'show' : ''}}" catchtap="stopPropagation">
            <view 
              wx:for="{{sortOptions}}" 
              wx:key="key"
              class="sort-dropdown-option {{selectedSort === item.key ? 'active' : ''}}"
              data-sort="{{item.key}}"
              bindtap="selectSort"
            >
              <text class="sort-option-icon">{{item.icon}}</text>
              <text class="sort-option-text">{{item.label}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{filteredInventoryList.length === 0}}" class="empty-state">
      <text class="empty-icon">ğŸ“­</text>
      <text class="empty-title">{{selectedFilter === 'all' ? 'æš‚æ— åº“å­˜' : 'è¯¥åˆ†ç±»æš‚æ— ç‰©å“'}}</text>
      <text class="empty-desc">{{selectedFilter === 'all' ? 'å¿«å»è´­ä¹°ä¸€äº›ç‰©å“å§ï¼' : 'å°è¯•åˆ‡æ¢å…¶ä»–åˆ†ç±»æŸ¥çœ‹'}}</text>
      <button wx:if="{{selectedFilter === 'all'}}" class="empty-btn" bindtap="goToPurchase">å»è´­ä¹°</button>
    </view>

    <!-- åº“å­˜ç‰©å“åˆ—è¡¨ -->
    <view wx:else class="inventory-list">
      <view 
        wx:for="{{filteredInventoryList}}" 
        wx:key="_id" 
        class="inventory-item"
        data-item="{{item}}"
        bindtap="showItemDetail"
      >
        <view class="item-header">
          <view class="item-info">
            <text class="item-name">{{item.item_name}}</text>
            <text class="item-type">{{item.displayType}}</text>
          </view>
          <view class="item-quantity">
            <text class="quantity-text">Ã—{{item.remaining_quantity}}</text>
          </view>
        </view>

        <!-- é‡æ–°è®¾è®¡çš„æˆæœ¬ä¿¡æ¯æ˜¾ç¤º -->
        <view class="item-costs">
          <view class="cost-item primary-item">
            <text class="cost-label">å¹³å‡å•ä»·</text>
            <text class="cost-value avg-price">Â¥{{item.avg_rmb_unit_price}} (${{item.avg_unit_price}})</text>
          </view>
          <view class="cost-item">
            <text class="cost-label">æˆæœ¬æ€»ä»·</text>
            <text class="cost-value total-cost">Â¥{{item.total_rmb_cost}} (${{item.total_usd_cost}})</text>
          </view>
          <view class="cost-item">
            <text class="cost-label">è´­ä¹°æ—¶é—´</text>
            <text class="cost-value purchase-time">{{item.first_purchase_time}}</text>
          </view>
        </view>

        <view class="item-actions" catchtap="true">
          <button 
            class="action-btn sell-btn" 
            data-item="{{item}}"
            catchtap="quickSell"
          >
            å‡ºè´§
          </button>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- ç‰©å“è¯¦æƒ…å¼¹çª— -->
<view wx:if="{{showDetail}}" class="detail-modal" bindtap="closeDetail">
  <view class="detail-content" catchtap="true">
    <button class="close-btn" bindtap="closeDetail">Ã—</button>
    <view class="detail-header">
      <view class="detail-title-group">
        <text class="detail-title">{{selectedItem.item_name}}</text>
        <text class="detail-subtitle">{{selectedItem.displayType}}</text>
      </view>
    </view>
    
    <view class="detail-body">
      <!-- æ ¸å¿ƒä¿¡æ¯å¡ç‰‡ -->
      <view class="detail-summary-card">
        <view class="summary-item">
          <text class="summary-label">åº“å­˜æ•°é‡</text>
          <text class="summary-value primary">{{selectedItem.remaining_quantity}} ä»¶</text>
        </view>
        <view class="summary-divider"></view>
        <view class="summary-item">
          <text class="summary-label">æ€»ä»·å€¼</text>
          <text class="summary-value secondary">Â¥{{selectedItem.total_rmb_cost}}</text>
        </view>
      </view>

      <!-- è¯¦ç»†ä¿¡æ¯ -->
      <view class="detail-section">
        <text class="section-title">ğŸ’° æˆæœ¬ä¿¡æ¯</text>
        <view class="detail-row">
          <text class="detail-label">å¹³å‡å•ä»·</text>
          <text class="detail-value">Â¥{{selectedItem.avg_rmb_unit_price}} (${{selectedItem.avg_unit_price}})</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">ç¾å…ƒæˆæœ¬</text>
          <text class="detail-value">${{selectedItem.total_usd_cost}}</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">äººæ°‘å¸æˆæœ¬</text>
          <text class="detail-value">Â¥{{selectedItem.total_rmb_cost}}</text>
        </view>
      </view>

      <view class="detail-section">
        <text class="section-title">ğŸ“… æ—¶é—´ä¿¡æ¯</text>
        <view class="detail-row">
          <text class="detail-label">é¦–æ¬¡è´­ä¹°</text>
          <text class="detail-value">{{selectedItem.first_purchase_time}}</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">æœ€åè´­ä¹°</text>
          <text class="detail-value">{{selectedItem.last_purchase_time}}</text>
        </view>
      </view>

      <!-- è´­ä¹°è®°å½•è¯¦æƒ… -->
      <view class="detail-section" wx:if="{{selectedItem.purchase_records && selectedItem.purchase_records.length > 1}}">
        <text class="section-title">ğŸ“‹ è´­ä¹°è®°å½•è¯¦æƒ…</text>
        <view class="purchase-records-list">
          <view class="purchase-record-item" wx:for="{{selectedItem.purchase_records}}" wx:key="id" wx:if="{{item.remaining_quantity > 0}}">
            <view class="record-header">
              <view class="record-info">
                <text class="record-date">{{item.purchase_time}}</text>
                <text class="record-remaining">å‰©ä½™ï¼š{{item.remaining_quantity}}/{{item.quantity}}</text>
              </view>
            </view>
            <view class="record-cost-grid">
              <view class="cost-item">
                <text class="cost-label">å•ä»·</text>
                <text class="cost-value">Â¥{{item.unit_price_cny}}</text>
              </view>
              <view class="cost-item">
                <text class="cost-label">å‰©ä½™æˆæœ¬</text>
                <text class="cost-value">Â¥{{item.remaining_cost_cny}}</text>
              </view>
            </view>
            <button 
              class="record-sell-btn" 
              data-record="{{item}}"
              bindtap="sellSpecificRecord"
            >
              å–å‡ºæ­¤æ‰¹æ¬¡
            </button>
          </view>
        </view>
      </view>
    </view>

    <view class="detail-actions">
      <button 
        class="detail-action-btn sell" 
        data-item="{{selectedItem}}"
        bindtap="quickSell"
      >
        ğŸ’° å‡ºè´§
      </button>
    </view>
  </view>
</view>

<!-- å–å‡ºå¼¹çª— -->
<view class="sell-modal {{showSellModal ? 'show' : ''}}" catchtap="closeSellModal">
  <view class="sell-modal-content" catchtap="stopPropagation">
    <!-- å¤´éƒ¨ -->
    <view class="sell-modal-header">
      <text class="sell-modal-title">å”®å‡º</text>
      <text class="sell-modal-close" bindtap="closeSellModal">Ã—</text>
    </view>
    
    <!-- ç‰©å“ä¿¡æ¯ -->
    <view class="sell-item-info" wx:if="{{selectedSellItem}}">
      <view class="sell-item-details">
        <view class="sell-item-name">{{selectedSellItem.item_name}}</view>
        <view class="sell-item-type">{{selectedSellItem.displayType}}</view>
      </view>
      
      <!-- æ‰¹æ¬¡ä¿¡æ¯æç¤º -->
      <view class="batch-info" wx:if="{{selectedSellItem.purchase_ids && selectedSellItem.purchase_ids.length === 1}}">
        <text class="batch-label">ğŸ·ï¸ é€‰å®šæ‰¹æ¬¡</text>
        <text class="batch-desc">æ­£åœ¨å–å‡ºç‰¹å®šè´­ä¹°æ‰¹æ¬¡çš„ç‰©å“</text>
      </view>
      
      <view class="sell-item-stats">
        <view class="sell-item-stock">åº“å­˜ï¼š{{selectedSellItem.remaining_quantity}}</view>
        <view class="sell-item-cost">æˆæœ¬ï¼šÂ¥{{selectedSellItem.avg_cost_cny || selectedSellItem.avg_rmb_unit_price}}</view>
      </view>
    </view>
    
    <!-- å–å‡ºè¡¨å• -->
    <view class="sell-form" wx:if="{{selectedSellItem}}">
      <!-- å–å‡ºå•ä»· -->
      <view class="form-item">
        <text class="form-label">å–å‡ºå•ä»·ï¼ˆÂ¥ï¼‰</text>
        <input 
          class="price-input" 
          type="digit" 
          placeholder="è¯·è¾“å…¥å–å‡ºå•ä»·" 
          value="{{sellPrice}}" 
          bindinput="onPriceInput" 
        />
      </view>
      
      <!-- å–å‡ºæ•°é‡ -->
      <view class="form-item">
        <text class="form-label">å–å‡ºæ•°é‡</text>
        <view class="quantity-input">
          <text class="quantity-btn" bindtap="decreaseQuantity">-</text>
          <input class="quantity-value" type="number" placeholder="è¯·è¾“å…¥æ•°é‡" value="{{sellQuantity}}" bindinput="onQuantityInput" />
          <text class="quantity-btn" bindtap="increaseQuantity">+</text>
        </view>
      </view>
      
      <!-- åˆ©æ¶¦é¢„è§ˆ -->
      <view class="profit-preview" wx:if="{{profitPreview.show}}">
        <view class="profit-summary">
          <view class="profit-main">
            <text class="profit-main-label">é¢„è®¡åˆ©æ¶¦</text>
            <text class="profit-main-value {{profitPreview.profit >= 0 ? 'profit-positive' : 'profit-negative'}}">
              Â¥{{profitPreview.profit}}
            </text>
          </view>
          <view class="profit-rate">
            <text class="profit-rate-label">åˆ©æ¶¦ç‡</text>
            <text class="profit-rate-value {{profitPreview.profitRate >= 0 ? 'profit-positive' : 'profit-negative'}}">
              {{profitPreview.profitRate}}%
            </text>
          </view>
        </view>
        <view class="profit-details">
          <view class="profit-detail-item">
            <text class="profit-detail-label">å–å‡ºä»·</text>
            <text class="profit-detail-value">Â¥{{profitPreview.totalSellPrice}}</text>
          </view>
          <view class="profit-detail-item">
            <text class="profit-detail-label">æˆæœ¬</text>
            <text class="profit-detail-value">Â¥{{profitPreview.totalCost}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <view class="sell-actions">
      <button class="sell-btn-cancel" bindtap="closeSellModal">å–æ¶ˆ</button>
      <button 
        class="sell-btn-confirm {{canSubmitSell ? '' : 'disabled'}}" 
        bindtap="confirmSell"
        disabled="{{!canSubmitSell}}"
      >
        ç¡®è®¤å–å‡º
      </button>
    </view>
  </view>
</view>


